<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
         "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- resources/mapper/HouseInfoMapper.xml -->
<mapper namespace="com.ssafy.house.model.dao.HouseInfoDao">
    <resultMap id="houseInfoMap" type="com.ssafy.house.model.dto.HouseInfo">
        <id column="apt_seq" property="aptSeq"/>
        <result column="sgg_cd" property="sggCd"/>
        <result column="umd_cd" property="umdCd"/>
        <result column="umd_nm" property="umdNm"/>
        <result column="jibun" property="jibun"/>
        <result column="road_nm_sgg_cd" property="roadNmSggCd"/>
        <result column="road_nm" property="roadNm"/>
        <result column="road_nm_bonbun" property="roadNmBonbun"/>
        <result column="road_nm_bubun" property="roadNmBubun"/>
        <result column="apt_nm" property="aptNm"/>
        <result column="build_year" property="buildYear"/>
        <result column="latitude" property="latitude"/>
        <result column="longitude" property="longitude"/>
    </resultMap>

    <!-- 단일 조회 -->
    <select id="selectHouseInfo" parameterType="string" resultMap="houseInfoMap">
    SELECT * FROM house_info
    WHERE apt_seq = #{aptSeq}
    </select>

    <!-- 범위 조회 -->
    <select id="selectByBounds" resultMap="houseInfoMap">
    SELECT *
    FROM house_info
    WHERE latitude BETWEEN #{minLat} AND #{maxLat}
    AND longitude BETWEEN #{minLng} AND #{maxLng}
    </select>

    <select id="selectBySeqList" resultMap="houseInfoMap" parameterType="list">
    SELECT * 
    FROM house_info 
    WHERE apt_seq IN
        <foreach item="seq" collection="list" open="(" separator="," close=")">
            #{seq}
        </foreach>
    </select>

    <!-- 아파트명 일부 검색 -->
    <select id="searchByAptName" parameterType="string" resultType="string">
    SELECT DISTINCT apt_seq FROM house_info
    WHERE apt_nm LIKE #{partialName}
    </select>


    <!-- 시도+구군 -->
    <select id="findBySidoGugun" resultType="string">
    SELECT DISTINCT hi.apt_seq
    FROM house_info hi
    JOIN dong_code dc
        ON LEFT(dc.dong_code,5) = hi.sgg_cd
    WHERE dc.sido_name LIKE CONCAT('%', #{sido}, '%')
    AND dc.gugun_name LIKE CONCAT('%', #{gugun}, '%')
    </select>

    <!-- 시도+구군+동 -->
    <select id="findBySidoGugunDong" resultType="string">
    SELECT DISTINCT hi.apt_seq
    FROM house_info hi
    JOIN dong_code dc
        ON LEFT(dc.dong_code,5) = hi.sgg_cd
        AND RIGHT(dc.dong_code,5)= hi.umd_cd
    WHERE dc.sido_name LIKE CONCAT('%', #{sido}, '%')
    AND dc.gugun_name LIKE CONCAT('%', #{gugun}, '%')
    AND dc.dong_name  LIKE CONCAT('%', #{dong}, '%')
    </select>

    <!-- 조합 검색 -->
    <select id="findByOptions" resultType="string">
    SELECT DISTINCT hi.apt_seq
    FROM house_info hi
    JOIN dong_code dc
        ON LEFT(dc.dong_code,5) = hi.sgg_cd
    WHERE 1=1
        <if test="sido != null">
            AND dc.sido_name LIKE CONCAT('%', #{sido}, '%')
        </if>
        <if test="gugun != null">
            AND dc.gugun_name LIKE CONCAT('%', #{gugun}, '%')
        </if>
        <if test="dong != null">
            AND dc.dong_name  LIKE CONCAT('%', #{dong}, '%')
        </if>
    </select>

    <!-- 조합 + 아파트명 -->
    <select id="findByOptionsAndAptName" resultType="string">
    SELECT DISTINCT hi.apt_seq
    FROM house_info hi
    JOIN dong_code dc
        ON LEFT(dc.dong_code,5) = hi.sgg_cd
    WHERE hi.apt_nm LIKE CONCAT('%', #{aptNm}, '%')
        <if test="sido != null">
            AND dc.sido_name LIKE CONCAT('%', #{sido}, '%')
        </if>
        <if test="gugun != null">
            AND dc.gugun_name LIKE CONCAT('%', #{gugun}, '%')
        </if>
        <if test="dong != null">
            AND dc.dong_name  LIKE CONCAT('%', #{dong}, '%')
        </if>
    </select>
</mapper>