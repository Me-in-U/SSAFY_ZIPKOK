<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
         "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.house.model.dao.HouseInfoDao">
  <!-- resultMap -->
  <resultMap id="houseInfoMap" type="com.ssafy.house.model.dto.HouseInfo">
    <id column="apt_seq" property="aptSeq"/>
    <result column="sgg_cd" property="sggCd"/>
    <result column="umd_cd" property="umdCd"/>
    <result column="umd_nm" property="umdNm"/>
    <result column="jibun" property="jibun"/>
    <result column="road_nm_sgg_cd" property="roadNmSggCd"/>
    <result column="road_nm" property="roadNm"/>
    <result column="road_nm_bonbun" property="roadNmBonbun"/>
    <result column="road_nm_bubun" property="roadNmBubun"/>
    <result column="apt_nm" property="aptNm"/>
    <result column="build_year" property="buildYear"/>
    <result column="latitude" property="latitude"/>
    <result column="longitude" property="longitude"/>
  </resultMap>

  <!-- 1) 단일 조회 -->
  <select id="selectHouseInfo" parameterType="string" resultMap="houseInfoMap">
    SELECT *
    FROM house_info
    WHERE apt_seq = #{aptSeq}
  </select>

  <!-- 2) 범위 조회 -->
  <select id="selectByBounds" parameterType="map" resultMap="houseInfoMap">
    SELECT *
    FROM house_info
    WHERE latitude  BETWEEN #{minLat} AND #{maxLat}
      AND longitude BETWEEN #{minLng} AND #{maxLng}
  </select>

  <!-- 3) 리스트 조회 -->
  <select id="selectBySeqList" parameterType="list" resultMap="houseInfoMap">
    SELECT *
    FROM house_info
    WHERE apt_seq IN
    <foreach item="seq" collection="list" open="(" separator="," close=")">
        #{seq}
    </foreach>
  </select>

  <!-- 4-1) 아파트명 일부 검색 -->
  <select id="searchByAptName" parameterType="string" resultType="string">
    SELECT DISTINCT apt_seq
    FROM house_info
    WHERE apt_nm LIKE #{partialName}
  </select>

  <!-- 4-2) 아파트명 일부 검색 -->
  <select id="searchByName" parameterType="string" resultType="com.ssafy.house.model.dto.HouseInfo">
    SELECT *
    FROM house_info
    WHERE apt_nm LIKE #{partialName}
  </select>
  <!-- 5) 시도 검색 -->
  <select id="findBySido" parameterType="map" resultType="string">
    SELECT DISTINCT hi.apt_seq
    FROM house_info hi
    JOIN dong_code dc
      ON LEFT(dc.dong_code,5) = hi.sgg_cd
    WHERE dc.sido_name  LIKE CONCAT('%', #{sido}, '%')
  </select>
  <!-- 5) 시도+구군 검색 -->
  <select id="findBySidoGugun" parameterType="map" resultType="string">
    SELECT DISTINCT hi.apt_seq
    FROM house_info hi
    JOIN dong_code dc
      ON LEFT(dc.dong_code,5) = hi.sgg_cd
    WHERE dc.sido_name  LIKE CONCAT('%', #{sido}, '%')
      AND dc.gugun_name LIKE CONCAT('%', #{gugun}, '%')
  </select>

  <!-- 6) 시도+구군+동 검색 -->
  <select id="findBySidoGugunDong" parameterType="map" resultType="string">
    SELECT DISTINCT hi.apt_seq
    FROM house_info hi
    JOIN dong_code dc
      ON LEFT(dc.dong_code,5) = hi.sgg_cd
     AND RIGHT(dc.dong_code,5)= hi.umd_cd
    WHERE dc.sido_name  LIKE CONCAT('%', #{sido}, '%')
      AND dc.gugun_name LIKE CONCAT('%', #{gugun}, '%')
      AND dc.dong_name  LIKE CONCAT('%', #{dong}, '%')
  </select>

  <!-- 7) 조합 검색 -->
  <select id="findByOptions" parameterType="map" resultType="string">
    SELECT DISTINCT hi.apt_seq
    FROM house_info hi
    JOIN dong_code dc
      ON LEFT(dc.dong_code,5) = hi.sgg_cd
    WHERE 1=1
    <if test="sido != null">
      AND dc.sido_name LIKE CONCAT('%', #{sido}, '%')
    </if>
    <if test="gugun != null">
      AND dc.gugun_name LIKE CONCAT('%', #{gugun}, '%')
    </if>
    <if test="dong != null">
      AND dc.dong_name  LIKE CONCAT('%', #{dong}, '%')
    </if>
  </select>

  <!-- 8) 조합 + 아파트명 -->
  <select id="findByOptionsAndAptName" parameterType="map" resultType="string">
    SELECT DISTINCT hi.apt_seq
    FROM house_info hi
    JOIN dong_code dc
      ON LEFT(dc.dong_code,5) = hi.sgg_cd
    WHERE hi.apt_nm LIKE CONCAT('%', #{aptNm}, '%')
    <if test="sido != null">
      AND dc.sido_name LIKE CONCAT('%', #{sido}, '%')
    </if>
    <if test="gugun != null">
      AND dc.gugun_name LIKE CONCAT('%', #{gugun}, '%')
    </if>
    <if test="dong != null">
      AND dc.dong_name  LIKE CONCAT('%', #{dong}, '%')
    </if>
  </select>

  <!-- 9) full info 매핑 -->
  <resultMap id="houseFullInfoMap" type="com.ssafy.house.model.dto.HouseFullInfo">
    <id column="apt_seq" property="aptSeq"/>
    <result column="apt_nm" property="aptNm"/>
    <result column="latitude" property="latitude"/>
    <result column="longitude" property="longitude"/>
    <result column="road_address" property="roadAddress"/>
    <result column="jibun" property="jibunAddress"/>
    <result column="build_year" property="buildYear"/>
    <result column="area_min" property="areaMin"/>
    <result column="area_max" property="areaMax"/>
    <result column="trade_price_min" property="tradePriceMin"/>
    <result column="trade_price_max" property="tradePriceMax"/>
    <result column="jeonse_price_min" property="jeonsePriceMin"/>
    <result column="jeonse_price_max" property="jeonsePriceMax"/>
    <result column="last_trade_detail" property="lastTradeDetail"/>
    <result column="img_path" property="imgPath"/>
    <result column="latest_price" property="latestPrice"/>
    <result column="latest_spec" property="latestSpec"/>
    <result column="latest_property_type" property="propertyType"/>
    <result column="latest_description" property="description"/>
  </resultMap>

  <!-- 10) 아파트 상세정보 -->
  <select id="selectHouseFullInfo" parameterType="string" resultMap="houseFullInfoMap">
    SELECT
        hi.apt_seq,
        hi.apt_nm,
        hi.latitude,
        hi.longitude,
        CONCAT(hi.road_nm,' ',hi.road_nm_bonbun,hi.road_nm_bubun) AS road_address,
        hi.jibun,
        hi.build_year,
        hd.area_min,
        hd.area_max,
        hd.trade_price_min,
        hd.trade_price_max,
        hd.jeonse_price_min,
        hd.jeonse_price_max,
        hd.last_trade_detail,
        img.img_path,
        deal.price           AS latest_price,
        deal.spec            AS latest_spec,
        deal.property_type   AS latest_property_type,
        deal.description     AS latest_description
    FROM house_info hi
    LEFT JOIN house_detail hd
        ON hd.apt_seq = hi.apt_seq
    LEFT JOIN (
        SELECT apt_seq, MIN(img_path) AS img_path
        FROM house_image
        GROUP BY apt_seq
    ) img
        ON img.apt_seq = hi.apt_seq
    LEFT JOIN (
        SELECT hd1.apt_seq,
                hd1.price,
                hd1.spec,
                hd1.property_type,
                hd1.description
        FROM house_deal hd1
        JOIN (
        SELECT apt_seq, MAX(confirmed_at) AS max_dt
        FROM house_deal
        GROUP BY apt_seq
        ) hd2
        ON hd1.apt_seq = hd2.apt_seq
        AND hd1.confirmed_at = hd2.max_dt
    ) deal
        ON deal.apt_seq = hi.apt_seq
    WHERE hi.apt_seq = #{aptSeq}
    LIMIT 1
  </select>

  <!-- 11) 주변 학교 매핑 -->
  <resultMap id="schoolInfoMap" type="com.ssafy.house.model.dto.SchoolInfo">
    <result column="school_name" property="schoolName"/>
    <result column="school_type" property="schoolType"/>
    <result column="distance" property="distance"/>
  </resultMap>
  <select id="selectSchoolsByAptSeq" parameterType="string" resultMap="schoolInfoMap">
    SELECT
      sd.school_name,
      sd.school_type,
      hs.distance
    FROM house_school hs
    JOIN school_detail sd ON sd.id = hs.school_id
    WHERE hs.apt_seq = #{aptSeq}
    ORDER BY CAST(SUBSTRING_INDEX(distance,'분',1) AS UNSIGNED)
  </select>
  <!-- 12) 마커 표시용 경량 쿼리 -->
  <select id="searchMarkersByOptionsAndName" parameterType="map" resultType="com.ssafy.house.model.dto.HouseInfo">
    SELECT
      hi.apt_seq    AS aptSeq,
      hi.apt_nm     AS aptNm,
      hi.latitude   AS latitude,
      hi.longitude  AS longitude
    FROM house_info hi

                <!-- 시·군·구 코드 매칭 -->
    LEFT JOIN dong_code dc
      ON LEFT(dc.dong_code,5) = hi.sgg_cd

    <where>
      <!-- 1) 아파트명 검색 -->
      <if test="partialName != null and partialName != ''">
        AND hi.apt_nm LIKE CONCAT('%', #{partialName}, '%')
      </if>

      <!-- 2) 시·도 -->
      <if test="sido != null and sido != ''">
        AND dc.sido_name LIKE CONCAT('%', #{sido}, '%')
      </if>

      <!-- 3) 구·군 -->
      <if test="gugun != null and gugun != ''">
        AND dc.gugun_name LIKE CONCAT('%', #{gugun}, '%')
      </if>

      <!-- 동 필터가 있을 때만 umd_cd 까지 추가 매칭 -->
      <if test="dong != null and dong != ''">
        AND RIGHT(dc.dong_code,5) = hi.umd_cd
        AND dc.dong_name   LIKE CONCAT('%', #{dong}, '%')
      </if>
    </where>
  </select>

</mapper>
