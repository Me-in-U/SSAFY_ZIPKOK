<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
         "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.house.model.dao.MemberFavoriteDao">
    <!-- 1. 즐겨찾기 추가 -->
    <insert id="insertFavorite">
    INSERT INTO member_favorite (mno, apt_seq)
    VALUES (#{mno}, #{aptSeq})
    </insert>

    <!-- 2. 즐겨찾기 삭제 -->
    <delete id="deleteFavorite">
    DELETE FROM member_favorite
    WHERE mno = #{mno}
      AND apt_seq = #{aptSeq}
    </delete>

    <!-- 3. 회원별 즐겨찾기 조회 -->
    <select id="selectFavoritesByMember" resultType="com.ssafy.house.model.dto.HouseRecommend">
    SELECT
        mf.apt_seq                       AS aptSeq,
        hi.apt_nm                        AS listingName,
        img.img_path                     AS imgPath,
        hd.price                         AS price,
        hd.spec                          AS spec,
        CAST(hd.description AS CHAR CHARACTER SET utf8mb4) AS description
    FROM member_favorite mf
    -- 기본 아파트 정보
    JOIN house_info hi
      ON hi.apt_seq = mf.apt_seq
    -- 최신 거래 정보 (confirmed_at 기준)
    JOIN (
        SELECT d1.apt_seq,
                d1.listing_name,
                d1.price,
                d1.spec,
                d1.description
        FROM house_deal d1
        JOIN (
            SELECT apt_seq, MAX(confirmed_at) AS max_date
            FROM house_deal
            GROUP BY apt_seq
        ) d2
          ON d1.apt_seq = d2.apt_seq
          AND d1.confirmed_at = d2.max_date
    ) hd
      ON hd.apt_seq = mf.apt_seq
    -- 대표 이미지: apt_seq별 최소 id를 가진 이미지
    LEFT JOIN (
        SELECT hi2.apt_seq, hi2.img_path
        FROM house_image hi2
        WHERE hi2.id = (
            SELECT MIN(id) FROM house_image WHERE apt_seq = hi2.apt_seq
        )
    ) img
      ON img.apt_seq = mf.apt_seq
    WHERE mf.mno = #{mno}
    </select>

</mapper>
