<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
         "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.house.model.dao.MemberFavoriteDao">
    <!-- 1. 즐겨찾기 추가 -->
    <insert id="insertFavorite">
    INSERT INTO member_favorite (mno, apt_seq)
    VALUES (#{mno}, #{aptSeq})
    </insert>

    <!-- 2. 즐겨찾기 삭제 -->
    <delete id="deleteFavorite">
    DELETE FROM member_favorite
    WHERE mno = #{mno}
      AND apt_seq = #{aptSeq}
    </delete>

    <!-- 3. 회원별 즐겨찾기 조회 -->
    <select id="selectFavoritesByMember" resultType="com.ssafy.house.model.dto.HouseRecommend">
    SELECT
      mf.apt_seq                                        AS aptSeq,
      hi.apt_nm                                         AS listingName,
      img.img_path                                      AS imgPath,
      hd.price                                          AS price,
      hd.spec                                           AS spec,
      CAST(hd.description AS CHAR CHARACTER SET utf8mb4) AS description
    FROM member_favorite mf
    -- 기본 아파트 정보는 반드시 있어야 하니 INNER JOIN
    JOIN house_info hi
      ON hi.apt_seq = mf.apt_seq

    -- 최신 거래 정보: LEFT JOIN 으로 바꿔서 없으면 NULL 로
    LEFT JOIN house_deal hd
      ON hd.deal_id = (
        SELECT d2.deal_id
        FROM house_deal d2
        WHERE d2.apt_seq = mf.apt_seq
        ORDER BY d2.confirmed_at DESC, d2.deal_id ASC
        LIMIT 1
      )

    -- 대표 이미지: LEFT JOIN 유지
    LEFT JOIN (
      SELECT hi2.apt_seq, hi2.img_path
      FROM house_image hi2
      WHERE hi2.id = (
        SELECT MIN(id)
        FROM house_image hi3
        WHERE hi3.apt_seq = hi2.apt_seq
      )
    ) img
      ON img.apt_seq = mf.apt_seq

    WHERE mf.mno = #{mno}
    </select>

</mapper>
