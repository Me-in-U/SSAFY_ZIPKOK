<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
         "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.house.model.dao.HouseRecommendDao">

  <!-- 1) 최근 거래 매물: 최근 confirmed_at 기준, 상위 6개 -->
  <select id="selectRecentProperties"
          parameterType="int"
          resultType="com.ssafy.house.model.dto.HouseRecommend">
    SELECT
      p.apt_seq        AS aptSeq,
      hi.img_path      AS imgPath,
      d.listing_name   AS listingName,
      d.price          AS price,
      d.spec           AS spec,
      CAST(d.description AS CHAR CHARACTER SET utf8mb4) AS description,
      d.property_type AS propertyType
    FROM (
      SELECT apt_seq, MAX(confirmed_at) AS last_date
      FROM house_deal
      WHERE price IS NOT NULL
      GROUP BY apt_seq
    ) p
    JOIN (
      SELECT apt_seq, MIN(img_path) AS img_path
      FROM house_image
      WHERE img_path IS NOT NULL
      GROUP BY apt_seq
    ) hi ON hi.apt_seq = p.apt_seq
    JOIN house_deal d
      ON d.apt_seq = p.apt_seq
    AND d.confirmed_at = p.last_date
    ORDER BY p.last_date DESC
    LIMIT #{limit}
  </select>

  <!-- 2) 역세권 매물: 상위 6개 -->
  <select id="selectNearStationProperties"
          resultType="com.ssafy.house.model.dto.HouseRecommend">
    SELECT
      hd.apt_seq,
      hi.img_path,
      hd.listing_name,
      hd.price,
      hd.spec,
      CAST(hd.description AS CHAR CHARACTER SET utf8mb4) AS description,
      hd.property_type AS propertyType
    FROM
      house_deal AS hd
    INNER JOIN
      house_image AS hi
        ON hi.apt_seq = hd.apt_seq
    WHERE
      hd.description LIKE '%역세권%'
    ORDER BY
      hd.confirmed_at
    LIMIT #{limit}
  </select>

  <!-- 3) 학교와 가까운 신혼 추천 매물: 상위 6개 -->
  <select id="selectNewlywedsProperties"
          parameterType="int"
          resultType="com.ssafy.house.model.dto.HouseRecommend">
    SELECT
      hd.apt_seq,
      hi.img_path,
      hd.listing_name,
      hd.price,
      hd.spec,
      CAST(hd.description AS CHAR CHARACTER SET utf8mb4) AS description,
      hs_min.min_distance_minutes AS school_distance_minutes,
      hd.property_type AS propertyType
    FROM
      house_deal AS hd
    JOIN (
      -- apt_seq별 최소 도보 시간(분) 계산
      SELECT
        apt_seq,
        MIN(
          CAST(
            SUBSTRING_INDEX(
              -- "도보로 15분" → SUBSTRING_INDEX(...,'분',1) = "도보로 15"
              SUBSTRING_INDEX(distance, '분', 1),
            ' ', -1)  -- "도보로 15" → 마지막 토큰 "15"
          AS UNSIGNED)
        ) AS min_distance_minutes
      FROM house_school
      GROUP BY apt_seq
    ) AS hs_min
      ON hs_min.apt_seq = hd.apt_seq
    INNER JOIN
      house_image AS hi
        ON hi.apt_seq = hd.apt_seq
    WHERE
      hd.description LIKE '%신혼%'     -- 신혼 대상 필터
    ORDER BY
      hs_min.min_distance_minutes ASC,  -- 가까운 순
      hd.confirmed_at            DESC -- 최신 거래순
    LIMIT #{limit}
  </select>

</mapper>
